<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="./res/map.png"/>
  <link rel="stylesheet" href="./res/leaflet.css"/>
  <script src="./res/leaflet.js"></script>
  <script src="./layers.js"></script>
  <script src="./controls.js"></script>
  <title>maps ~sunsetkookaburra</title>
  <style>
    body {
      margin: 0;
    }
    #map {
      margin: auto;
      width: 100%;
      height: calc(100vh);
    }
    .skmaps-control-home, .skmaps-control-line, .skmaps-control-point {
      font-size: 18px;
      text-shadow: 0px 2px 3px black;
    }
    .skmaps-control-active {
      box-shadow: inset 0 2px 4px 1px black;
    }
  </style>
</head>
<body>
  <figure id="map"></figure>
  <script>
    let STATE = "pan";
    let NEWPOINT;

    const SYDNEY = L.latLng(-33.85, 151.20);
    let MOUSE = SYDNEY;

    const map = L.map("map", {
      center: SYDNEY,
      zoom: 13,
    });

    map.on("mousemove", function (ev) {
      MOUSE = ev.latlng;
    });

    skmaps.tiles.osm.addTo(map);
    L.control.layers({
      "🗺️ OpenStreetMap": skmaps.tiles.osm,
      "🐨 NSW Imagery": skmaps.tiles.six,
      "✈️ Sydney 1943": skmaps.tiles.six1943,
      "🛰️ ESRI World Imagery": skmaps.tiles.esri,
    }).addTo(map);

    L.control.scale().addTo(map);

    L.Control.Drawing = L.Control.extend({
      options: {
        position: "topleft",
      },
      onAdd: function (map) {
        const menu = L.DomUtil.create("div", "leaflet-bar leaflet-control");
        const home = L.DomUtil.create("a", "skmaps-control-home", menu);
        home.href = "#home";
        home.title = "Home";
        home.textContent = "🏠";
        const point = L.DomUtil.create("a", "skmaps-control-point", menu);
        point.href = "#point";
        point.title = "Point";
        point.textContent = "📍";

        let cancelState = null;
        let state = null;

        L.DomEvent.disableClickPropagation(home);
        L.DomEvent.on(home, "click", function (ev) {
          ev.preventDefault();
          window.location = window.location.pathname;
        });

        function cancelPoint() {
          map.off("mousemove", moveState);
          point.classList.remove("skmaps-control-active");
          state.remove();
          state = null;
        }

        function moveState() {
          state.setLatLng(MOUSE);
        }

        L.DomEvent.disableClickPropagation(point);
        L.DomEvent.on(point, "click", function (ev) {
          ev.preventDefault();

          cancelState?.();
          if (cancelState === cancelPoint) {
            cancelState = null;
            return;
          }

          // if (ev instanceof TouchEvent) {
          //   L.marker(map.getCenter(), {
          //     draggable: true,
          //     autoPan: true,
          //   }).bindPopup((marker) => {
          //     const { lat, lng } = marker.getLatLng();
          //     const div = L.DomUtil.create("div");
          //     div.insertAdjacentHTML("afterbegin", `<a href="?lat=${roundPlaces(lat, 6)}&lon=${roundPlaces(lng, 6)}"><span style="user-select:none">Lat: </span>${roundPlaces(lat, 6)},<br/><span style="user-select:none">Lon: </span>${roundPlaces(lng, 6)}</a><br/><br/>`);
          //     const a = L.DomUtil.create("a", "", div);
          //     a.href = "#remove";
          //     a.textContent = "Remove";
          //     L.DomEvent.on(a, "click", function (ev) {
          //       ev.preventDefault();
          //       L.DomEvent.off(a);
          //       marker.remove();
          //     });
          //     return div;
          //   }).addTo(map);
          //   return;
          // }

          cancelState = cancelPoint;

          point.classList.add("skmaps-control-active");
          state = L.marker(MOUSE, {
            draggable: true,
            autoPan: true,
          });
          map.on("mousemove", moveState);
          function plop() {
            map.off("mousemove", moveState);
            map.off("click", plop);
            point.classList.remove("skmaps-control-active");
            cancelState = null;
            state = null;
          }
          map.on("click", plop);
          state.addTo(map);


          state.bindPopup((marker) => {
            const { lat, lng } = marker.getLatLng();
            const div = L.DomUtil.create("div");
            div.insertAdjacentHTML("afterbegin", `<a href="?lat=${roundPlaces(lat, 6)}&lon=${roundPlaces(lng, 6)}"><span style="user-select:none">Lat: </span>${roundPlaces(lat, 6)},<br/><span style="user-select:none">Lon: </span>${roundPlaces(lng, 6)}</a><br/><br/>`);
            const a = L.DomUtil.create("a", "", div);
            a.href = "#remove";
            a.textContent = "Remove";
            L.DomEvent.on(a, "click", function (ev) {
              ev.preventDefault();
              L.DomEvent.off(a);
              marker.remove();
            });
            return div;
          });
        });
        // const line = L.DomUtil.create("a", "skmaps-control-line", menu);
        // line.href = "#";
        // line.title = "Line";
        // line.textContent = "✏️";
        return menu;
      },
      onRemove: function (map) {
        for (const child of this.getContainer()) {
          L.DomEvent.off(child);
        }
      }
    });

    L.control.drawing = function (opts) {
      return new L.Control.Drawing(opts);
    }

    const drawing = L.control.drawing().addTo(map);

    L.control.Debug = L.Control.extend({
      options: {
        position: "bottomright",
      },
      onAdd: function (map) {
        const pre = L.DomUtil.create("pre");
        this._out = L.DomUtil.create("samp", "", pre);
        return pre;
      },
      print: function (data) {
        this._out.textContent = data;
      },
    });

    L.control.debug = function (opts) {
      return new L.control.Debug(opts);
    }

    const debug = L.control.debug().addTo(map);

    function roundPlaces(x, n) {
      return Math.trunc(x * (10 ** n)) / (10 ** n);
    }

    function panQuery(animate = true) {
      const params = new URLSearchParams(window.location.search);
      const lat = Number(params.get("lat") ?? undefined);
      const lon = Number(params.get("lon") ?? undefined);
      const latlng = (isNaN(lat) || isNaN(lon)) ? SYDNEY : L.latLng([lat, lon]);
      map.panTo(latlng, { animate });
      return latlng;
    }

    window.addEventListener("DOMContentLoaded", function (ev) {
      if (!window.location.search) return;
      const marker = L.marker(panQuery(false), {
        draggable: true,
        autoPan: true,
      }).addTo(map);
      marker.bindPopup((marker) => {
        const { lat, lng } = marker.getLatLng();
        const div = L.DomUtil.create("div");
        div.insertAdjacentHTML("afterbegin", `<a href="?lat=${roundPlaces(lat, 6)}&lon=${roundPlaces(lng, 6)}"><span style="user-select:none">Lat: </span>${roundPlaces(lat, 6)},<br/><span style="user-select:none">Lon: </span>${roundPlaces(lng, 6)}</a><br/><br/>`);
        const a = L.DomUtil.create("a", "", div);
        a.href = "#";
        a.textContent = "Remove";
        L.DomEvent.on(a, "click", function (ev) {
          ev.preventDefault();
          L.DomEvent.off(a);
          marker.remove();
        });
        return div;
      });
    });
  </script>
</body>
</html>
