<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="./res/map.png"/>
  <link rel="stylesheet" href="./res/leaflet.css"/>
  <script src="./res/leaflet.js"></script>
  <title>maps ~sunsetkookaburra</title>
  <style>
    body {
      margin: 0;
    }
    #map {
      margin: auto;
      width: 100%;
      height: calc(100vh);
    }
    .skmaps-control-home, .skmaps-control-line, .skmaps-control-point {
      font-size: 18px;
      text-shadow: 0px 2px 3px black;
    }
  </style>
</head>
<body>
  <figure id="map"></figure>
  <script>
    let STATE = "pan";
    let NEWPOINT;

    const SYDNEY = L.latLng(-33.85, 151.20);

    const map = L.map("map", {
      center: SYDNEY,
      zoom: 13,
    });

    const osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    const six = L.tileLayer("https://maps{s}.six.nsw.gov.au/arcgis/rest/services/sixmaps/LPI_Imagery_Best/MapServer/tile/{z}/{y}/{x}", {
      subdomains: "1234",
      maxZoom: 21,
      attribution: '&copy; <a href="https://maps.six.nsw.gov.au/">NSW Gov. CC-BY 4.0</a>'
    });

    const esri = L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png", {
      maxZoom: 19,
      attribution: '&copy; ESRI',
    });

    const six1943 = L.tileLayer("https://maps.six.nsw.gov.au/arcgis/rest/services/sixmaps/sydney1943/MapServer/tile/{z}/{y}/{x}", {
      maxZoom: 19,
    });

    L.control.layers({
      "🗺️ OpenStreetMap": osm,
      "🐨 NSW Imagery": six,
      "✈️ Sydney 1943": six1943,
      "🛰️ ESRI World Imagery": esri,
    }).addTo(map);

    L.control.scale().addTo(map);

    L.Control.Drawing = L.Control.extend({
      options: {
        position: "topleft",
      },
      onAdd: function (map) {
        const menu = L.DomUtil.create("div", "leaflet-bar leaflet-control");
        const home = L.DomUtil.create("a", "skmaps-control-home", menu);
        home.href = "#home";
        home.title = "Home";
        home.textContent = "🏠";
        L.DomEvent.disableClickPropagation(home);
        L.DomEvent.on(home, "click", function (ev) {
          ev.preventDefault();
          window.location = window.location.pathname;
        });
        const point = L.DomUtil.create("a", "skmaps-control-point", menu);
        point.href = "#point";
        point.title = "Point";
        point.textContent = "📍";
        L.DomEvent.disableClickPropagation(point);
        L.DomEvent.on(point, "click", function (ev) {
          ev.preventDefault();
          const marker = L.marker(map.getCenter(), {
            draggable: true,
            autoPan: true,
          }).addTo(map);
          marker.bindPopup((marker) => {
            const { lat, lng } = marker.getLatLng();
            const div = L.DomUtil.create("div");
            div.insertAdjacentHTML("afterbegin", `<a href="?lat=${lat}&lon=${lng}"><span style="user-select:none">Lat: </span>${lat},<br/><span style="user-select:none">Lon: </span>${lng}</a><br/><br/>`);
            const a = L.DomUtil.create("a", "", div);
            a.href = "#remove";
            a.textContent = "Remove";
            L.DomEvent.on(a, "click", function (ev) {
              ev.preventDefault();
              L.DomEvent.off(a);
              marker.remove();
            });
            return div;
          });
        });
        // const line = L.DomUtil.create("a", "skmaps-control-line", menu);
        // line.href = "#";
        // line.title = "Line";
        // line.textContent = "✏️";
        return menu;
      },
      onRemove: function (map) {
        for (const child of this.getContainer()) {
          L.DomEvent.off(child);
        }
      }
    });

    L.control.drawing = function (opts) {
      return new L.Control.Drawing(opts);
    }

    const drawing = L.control.drawing().addTo(map);

    function panQuery(animate = true) {
      const params = new URLSearchParams(window.location.search);
      const lat = Number(params.get("lat") ?? undefined);
      const lon = Number(params.get("lon") ?? undefined);
      const latlng = (isNaN(lat) || isNaN(lon)) ? SYDNEY : L.latLng([lat, lon]);
      map.panTo(latlng, { animate });
    }

    window.addEventListener("DOMContentLoaded", function (ev) {
      if (!window.location.search) return;
      panQuery(false);
      const marker = L.marker(map.getCenter(), {
        draggable: true,
        autoPan: true,
      }).addTo(map);
      marker.bindPopup((marker) => {
        const { lat, lng } = marker.getLatLng();
        const div = L.DomUtil.create("div");
        div.insertAdjacentHTML("afterbegin", `<a href="?lat=${lat}&lon=${lng}"><span style="user-select:none">Lat: </span>${lat},<br/><span style="user-select:none">Lon: </span>${lng}</a><br/><br/>`);
        const a = L.DomUtil.create("a", "", div);
        a.href = "#";
        a.textContent = "Remove";
        L.DomEvent.on(a, "click", function (ev) {
          ev.preventDefault();
          L.DomEvent.off(a);
          marker.remove();
        });
        return div;
      });
    });
  </script>
</body>
</html>
